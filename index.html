<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Code Ninjas AI Academy - WebXR Experience</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        /* Base layout */
        body {
            margin: 0;
            font-family: 'Arial', sans-serif;
            overflow: hidden;
            background: #000;
        }
        #canvas-container {
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        /* Chat bubble */
        #chat-bubble {
            position: absolute;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 15px 20px;
            border-radius: 20px;
            max-width: 400px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            display: none;
            font-size: 16px;
            z-index: 1000;
            border: 3px solid #7FD234;
            animation: fadeIn 0.3s ease-in;
        }
        #chat-bubble #chat-close {
            position: absolute;
            top: 6px;
            right: 10px;
            background: transparent;
            border: none;
            color: #555;
            font-size: 18px;
            cursor: pointer;
            line-height: 1;
        }
        #chat-bubble #chat-close:hover { color: #000; }
        #chat-bubble:after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-top: 15px solid white;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(-50%) translateY(-10px); }
            to   { opacity: 1; transform: translateX(-50%) translateY(0); }
        }

        /* Controls row */
        #controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 1000;
        }
        button {
            background: #7FD234;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        button:hover {
            background: #6BC024;
            transform: scale(1.05);
            box-shadow: 0 6px 15px rgba(0,0,0,0.3);
        }
        button:active { transform: scale(0.95); }
        button.active { background: #FF6B00; }

        /* VR button */
        #vr-button {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: #FF6B00;
            z-index: 1000;
        }
        #vr-button:hover { background: #E55A00; }

        /* Listening indicator */
        #listening-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #FF6B00;
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            display: none;
            z-index: 1000;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Live question preview */
        #user-question {
            position: absolute;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            display: none;
            max-width: 500px;
            z-index: 999;
        }

        /* Loading overlay */
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 24px;
            z-index: 2000;
        }

        /* Music toggle */
        #music-toggle {
            position: absolute;
            top: 20px;
            left: 20px;
            background: #333;
            color: white;
            padding: 10px;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1000;
        }
        #music-toggle:hover { background: #555; }

        /* Student chatter pop-up */
        #student-chat {
            position: absolute;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.9);
            padding: 10px;
            border-radius: 10px;
            max-width: 200px;
            display: none;
            font-size: 14px;
            z-index: 999;
        }

        /* Hidden YouTube iframe for music */
        #music-frame {
            display: none; /* We control play/pause via JS API; keep it invisible */
        }
    </style>
</head>
<body>
    <div id="loading">Loading Code Ninjas AI Academy...</div>
    <div id="canvas-container"></div>

    <!-- Chat bubble -->
    <div id="chat-bubble">
        <button id="chat-close" aria-label="Close">√ó</button>
        <span id="chat-text"></span>
    </div>

    <div id="listening-indicator">üé§ Listening...</div>
    <div id="user-question"></div>
    <div id="student-chat"></div>
    <div id="music-toggle">üéµ</div>

    <div id="controls">
        <button id="speak-btn">üé§ Talk to Ninja</button>
        <button id="info-btn">‚ÑπÔ∏è About AI Academy</button>
        <!-- Whiteboard button removed -->
    </div>
    <button id="vr-button">Enter VR</button>

    <!-- YouTube music embed (your track) -->
    <iframe
        id="music-frame"
        width="0"
        height="0"
        src="https://www.youtube.com/embed/7PvYu-1iEbY?enablejsapi=1&loop=1&playlist=7PvYu-1iEbY&rel=0"
        title="YouTube video player"
        frameborder="0"
        allow="autoplay; encrypted-media"
        referrerpolicy="strict-origin-when-cross-origin"
    ></iframe>

    <!-- YouTube IFrame API -->
    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        // Handle YouTube music toggle
        let ytPlayer;
        function onYouTubeIframeAPIReady() {
            ytPlayer = new YT.Player('music-frame', {
                events: {
                    'onReady': function () {
                        // Ready to be controlled by button taps
                    }
                }
            });
        }

        document.getElementById('music-toggle').addEventListener('click', () => {
            if (!ytPlayer || !ytPlayer.getPlayerState) return;
            // 1 = playing, 2 = paused
            const state = ytPlayer.getPlayerState();
            if (state !== 1) {
                try { ytPlayer.playVideo(); } catch (e) {}
                document.getElementById('music-toggle').textContent = 'üîá';
            } else {
                try { ytPlayer.pauseVideo(); } catch (e) {}
                document.getElementById('music-toggle').textContent = 'üéµ';
            }
        });
    </script>

    <script>
        // ----------------- AI Academy Knowledge Base -----------------
        const aiAcademyInfo = {
            overview:
                "The AI Academy is a comprehensive learning program designed to introduce Ninjas to the fascinating world of artificial intelligence. It combines creativity, problem-solving, and technical skills with a strong foundation in ethical AI use.",
            modules: [
                { name: "AI Fundamentals", description: "Learn how AI works, how it's trained, and how to use it responsibly. Master the art of crafting effective prompts." },
                { name: "Creative AI", description: "Use generative AI tools to produce art, music, and writing. Build stories, poems, podcasts, and books with AI assistance." },
                { name: "AI in Daily Life", description: "Explore digital assistants, face-recognition tools, and create your own chatbots and interactive creations." },
                { name: "AI for Coding", description: "Use AI to support your coding journey. Learn how AI can explain, debug, and generate code." },
                { name: "AI in Gaming", description: "Discover how AI powers non-player characters, levels, and entire virtual worlds." },
                { name: "AI Robotics", description: "Work with micro:bits and LEGO SPIKE Prime kits to design robots that use sensors and AI to interact intelligently." },
                { name: "Future of AI", description: "Understand how AI is transforming industries, careers, and society with emphasis on social good and ethics." },
                { name: "Capstone Project", description: "Identify real-world problems and design AI-powered solutions through a design-thinking process." },
                { name: "Advanced Module", description: "Optional extended training in Python and APIs to build custom generative AI applications." }
            ],
            mission: "To prepare learners to understand both the capabilities and responsibilities that come with using AI.",
            skills: ["Creativity", "Problem-solving", "Technical skills", "Ethical AI use", "Critical thinking", "Hands-on exploration"]
        };

        const studentChatter = [
            "This AI stuff is so cool!",
            "I just made my first chatbot!",
            "Can't wait for robotics module!",
            "My game AI beat me!",
            "Python is easier than I thought!",
            "I love the creative AI projects!",
            "Just debugged my code with AI!",
            "This is way better than regular coding!",
            "I'm going to be an AI engineer!",
            "The ethics module was interesting!"
        ];

        // ----------------- Three.js & Audio -----------------
        let scene, camera, renderer, ninja, studentAvatars = [], audioContext, listener, ninjaSound;
        let backgroundMusic; // (no longer used for oscillator)
        let musicPlaying = false;

        function init() {
            // Scene
            scene = new THREE.Scene();
            scene.fog = new THREE.Fog(0xcccccc, 10, 100);

            // Camera
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 2.5, 8);
            camera.lookAt(0, 2, 0);

            // Audio listener (for positional audio on the ninja, not the YouTube music)
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            listener = new THREE.AudioListener();
            camera.add(listener);

            // Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            renderer.setClearColor(0xf0f0f0);
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            // Lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(5, 10, 5);
            directionalLight.castShadow = true;
            directionalLight.shadow.camera.near = 0.1;
            directionalLight.shadow.camera.far = 50;
            directionalLight.shadow.camera.left = -10;
            directionalLight.shadow.camera.right = 10;
            directionalLight.shadow.camera.top = 10;
            directionalLight.shadow.camera.bottom = -10;
            scene.add(directionalLight);

            const pointLight = new THREE.PointLight(0xffffff, 0.5);
            pointLight.position.set(-5, 5, 5);
            scene.add(pointLight);

            createClassroom();
            ninja = createNinja();
            createStudentAvatars();

            // Hide loading
            document.getElementById('loading').style.display = 'none';
        }

        function createClassroom() {
            // Floor
            const floorGeometry = new THREE.PlaneGeometry(20, 20);
            const floorMaterial = new THREE.MeshLambertMaterial({ color: 0x808080 });
            const floor = new THREE.Mesh(floorGeometry, floorMaterial);
            floor.rotation.x = -Math.PI / 2;
            floor.receiveShadow = true;
            scene.add(floor);

            // Walls
            const wallMaterial = new THREE.MeshLambertMaterial({ color: 0xf0f0f0 });

            const backWall = new THREE.Mesh(new THREE.PlaneGeometry(20, 10), wallMaterial);
            backWall.position.z = -10;
            backWall.position.y = 5;
            backWall.receiveShadow = true;
            scene.add(backWall);

            const leftWallMaterial = new THREE.MeshLambertMaterial({ color: 0x7FD234 });
            const leftWall = new THREE.Mesh(new THREE.PlaneGeometry(20, 10), leftWallMaterial);
            leftWall.rotation.y = Math.PI / 2;
            leftWall.position.x = -10;
            leftWall.position.y = 5;
            scene.add(leftWall);

            const rightWall = new THREE.Mesh(new THREE.PlaneGeometry(20, 10), wallMaterial);
            rightWall.rotation.y = -Math.PI / 2;
            rightWall.position.x = 10;
            rightWall.position.y = 5;
            scene.add(rightWall);

            // Tables + laptops
            for (let i = 0; i < 3; i++) {
                for (let j = 0; j < 2; j++) {
                    const tableGeometry = new THREE.BoxGeometry(2, 0.1, 1.2);
                    const tableMaterial = new THREE.MeshLambertMaterial({ color: 0xd4d4d4 });
                    const table = new THREE.Mesh(tableGeometry, tableMaterial);
                    table.position.set(-4 + i * 4, 0.8, -2 + j * 3);
                    table.castShadow = true;
                    table.receiveShadow = true;
                    scene.add(table);

                    for (let k = 0; k < 4; k++) {
                        const legGeometry = new THREE.CylinderGeometry(0.05, 0.05, 0.8);
                        const leg = new THREE.Mesh(legGeometry, tableMaterial);
                        leg.position.set(
                            -4 + i * 4 + (k < 2 ? -0.9 : 0.9),
                            0.4,
                            -2 + j * 3 + (k % 2 === 0 ? -0.5 : 0.5)
                        );
                        leg.castShadow = true;
                        scene.add(leg);
                    }

                    const laptopMaterial = new THREE.MeshLambertMaterial({ color: 0x333333 });
                    const base = new THREE.Mesh(new THREE.BoxGeometry(0.4, 0.02, 0.3), laptopMaterial);
                    base.position.set(-4 + i * 4, 0.86, -2 + j * 3);
                    base.castShadow = true;
                    scene.add(base);

                    const screen = new THREE.Mesh(new THREE.BoxGeometry(0.4, 0.3, 0.02), laptopMaterial);
                    screen.position.set(-4 + i * 4, 1.01, -2 + j * 3 - 0.15);
                    screen.rotation.x = -0.3;
                    screen.castShadow = true;
                    scene.add(screen);
                }
            }

        }

        function createStudentAvatars() {
            const positions = [
                { x: -4, z: -2 },
                { x: 0, z: -2 },
                { x: 4, z: 1 },
                { x: -4, z: 1 }
            ];

            const colors = [0x1a1a1a, 0x2a2a2a, 0x3a3a3a, 0x4a4a4a];
            const beltColors = [0xffff00, 0xff6600, 0x00ff00, 0x800080]; // Yellow, Orange, Green, Purple belts

            positions.forEach((pos, index) => {
                const studentGroup = new THREE.Group();

                // Chair
                const chairMaterial = new THREE.MeshLambertMaterial({ color: 0x666666 });
                const chairSeat = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.05, 0.5), chairMaterial);
                chairSeat.position.y = 0.5;
                studentGroup.add(chairSeat);

                const chairBackMesh = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.6, 0.05), chairMaterial);
                chairBackMesh.position.set(0, 0.8, -0.225);
                studentGroup.add(chairBackMesh);

                // Student body
                const bodyMaterial = new THREE.MeshLambertMaterial({ color: colors[index] });
                const torso = new THREE.Mesh(new THREE.CylinderGeometry(0.3, 0.3, 0.8, 8), bodyMaterial);
                torso.position.y = 1.1;
                studentGroup.add(torso);

                const head = new THREE.Mesh(new THREE.SphereGeometry(0.2, 16, 16), bodyMaterial);
                head.position.y = 1.7;
                studentGroup.add(head);

                const belt = new THREE.Mesh(
                    new THREE.TorusGeometry(0.31, 0.05, 4, 12),
                    new THREE.MeshLambertMaterial({ color: beltColors[index] })
                );
                belt.position.y = 1;
                belt.rotation.x = Math.PI / 2;
                studentGroup.add(belt);

                const leftArm = new THREE.Mesh(new THREE.CylinderGeometry(0.08, 0.08, 0.4, 6), bodyMaterial);
                leftArm.position.set(-0.35, 1.1, 0.2);
                leftArm.rotation.z = 0.8;
                leftArm.rotation.x = -0.5;
                studentGroup.add(leftArm);

                const rightArm = new THREE.Mesh(new THREE.CylinderGeometry(0.08, 0.08, 0.4, 6), bodyMaterial);
                rightArm.position.set(0.35, 1.1, 0.2);
                rightArm.rotation.z = -0.8;
                rightArm.rotation.x = -0.5;
                studentGroup.add(rightArm);

                studentGroup.position.set(pos.x, 0, pos.z);
                studentGroup.userData = { leftArm, rightArm, animationOffset: Math.random() * Math.PI * 2 };
                scene.add(studentGroup);
                studentAvatars.push(studentGroup);
            });
        }

        function createNinja() {
            const ninjaGroup = new THREE.Group();
            ninjaSound = new THREE.PositionalAudio(listener);
            ninjaGroup.add(ninjaSound);

            const bodyGroup = new THREE.Group();
            const bodyMaterial = new THREE.MeshLambertMaterial({ color: 0x1a1a1a });
            const bodyMesh = new THREE.Mesh(new THREE.CylinderGeometry(0.8, 0.8, 1.5, 16), bodyMaterial);
            bodyMesh.position.y = 1.5;
            bodyMesh.castShadow = true;
            bodyGroup.add(bodyMesh);

            const topCap = new THREE.Mesh(new THREE.SphereGeometry(0.8, 16, 16), bodyMaterial);
            topCap.position.y = 2.25;
            topCap.castShadow = true;
            bodyGroup.add(topCap);

            const bottomCap = new THREE.Mesh(new THREE.SphereGeometry(0.8, 16, 16), bodyMaterial);
            bottomCap.position.y = 0.75;
            bottomCap.castShadow = true;
            bodyGroup.add(bottomCap);

            ninjaGroup.add(bodyGroup);

            const head = new THREE.Mesh(new THREE.SphereGeometry(0.6, 32, 32), bodyMaterial);
            head.position.y = 3;
            head.castShadow = true;
            ninjaGroup.add(head);

            const face = new THREE.Mesh(
                new THREE.BoxGeometry(0.8, 0.3, 0.2),
                new THREE.MeshLambertMaterial({ color: 0xfdb99b })
            );
            face.position.set(0, 3, 0.5);
            ninjaGroup.add(face);

            const eyeMaterial = new THREE.MeshLambertMaterial({ color: 0x00ffff, emissive: 0x00ffff, emissiveIntensity: 0.3 });
            const leftEye = new THREE.Mesh(new THREE.SphereGeometry(0.08, 16, 16), eyeMaterial);
            leftEye.position.set(-0.2, 3, 0.58);
            ninjaGroup.add(leftEye);
            const rightEye = new THREE.Mesh(new THREE.SphereGeometry(0.08, 16, 16), eyeMaterial);
            rightEye.position.set(0.2, 3, 0.58);
            ninjaGroup.add(rightEye);

            const belt = new THREE.Mesh(new THREE.TorusGeometry(0.85, 0.1, 8, 20), new THREE.MeshLambertMaterial({ color: 0x0066ff }));
            belt.position.y = 1.2;
            belt.rotation.x = Math.PI / 2;
            ninjaGroup.add(belt);

            const armMaterial = bodyMaterial;
            const leftArmGroup = new THREE.Group();
            leftArmGroup.add(new THREE.Mesh(new THREE.CylinderGeometry(0.2, 0.2, 0.8, 8), armMaterial));
            const lcap1 = new THREE.Mesh(new THREE.SphereGeometry(0.2, 8, 8), armMaterial); lcap1.position.y = 0.4; leftArmGroup.add(lcap1);
            const lcap2 = new THREE.Mesh(new THREE.SphereGeometry(0.2, 8, 8), armMaterial); lcap2.position.y = -0.4; leftArmGroup.add(lcap2);
            leftArmGroup.position.set(-1, 2, 0);
            leftArmGroup.rotation.z = 0.3;
            ninjaGroup.add(leftArmGroup);

            const rightArmGroup = new THREE.Group();
            rightArmGroup.add(new THREE.Mesh(new THREE.CylinderGeometry(0.2, 0.2, 0.8, 8), armMaterial));
            const rcap1 = new THREE.Mesh(new THREE.SphereGeometry(0.2, 8, 8), armMaterial); rcap1.position.y = 0.4; rightArmGroup.add(rcap1);
            const rcap2 = new THREE.Mesh(new THREE.SphereGeometry(0.2, 8, 8), armMaterial); rcap2.position.y = -0.4; rightArmGroup.add(rcap2);
            rightArmGroup.position.set(1, 2, 0);
            rightArmGroup.rotation.z = -0.3;
            ninjaGroup.add(rightArmGroup);

            ninjaGroup.position.set(0, 0, 3);
            scene.add(ninjaGroup);
            return ninjaGroup;
        }

        // ----------------- Animation -----------------
        let time = 0;
        let studentChatterTimer = 0;

        function animate() {
            requestAnimationFrame(animate);
            time += 0.01;
            studentChatterTimer += 0.01;

            if (ninja) {
                ninja.rotation.y = Math.sin(time) * 0.1;
                ninja.position.y = Math.sin(time * 2) * 0.05;
            }
            studentAvatars.forEach((student) => {
                const offset = student.userData.animationOffset;
                if (student.userData.leftArm) {
                    student.userData.leftArm.rotation.x = -0.5 + Math.sin(time * 8 + offset) * 0.1;
                    student.userData.rightArm.rotation.x = -0.5 + Math.sin(time * 8 + offset + 0.5) * 0.1;
                }
                student.rotation.y = Math.sin(time * 0.5 + offset) * 0.05;
            });
            if (studentChatterTimer > 10) {
                studentChatterTimer = 0;
                if (Math.random() > 0.7) showStudentChatter();
            }
            renderer.render(scene, camera);
        }

        function showStudentChatter() {
            const chatter = document.getElementById('student-chat');
            chatter.textContent = studentChatter[Math.floor(Math.random() * studentChatter.length)];
            chatter.style.display = 'block';
            setTimeout(() => { chatter.style.display = 'none'; }, 3000);
        }

        // Initialize scene
        init();
        animate();

        // ----------------- Chat + TTS (fixed) -----------------
        const chatBubble = document.getElementById('chat-bubble');
        const chatText = document.getElementById('chat-text');
        const chatClose = document.getElementById('chat-close');
        const userQuestion = document.getElementById('user-question');

        // Queue speech if we're still listening; say it on recognition.end
        let __pendingSpeech = null;

        function speakText(text) {
            if (!('speechSynthesis' in window)) return;
            const doSpeak = () => {
                try { speechSynthesis.cancel(); } catch {}
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 0.95;
                utterance.pitch = 1.05;
                speechSynthesis.speak(utterance);
            };
            if (window.__isListening) {
                __pendingSpeech = text;
            } else {
                doSpeak();
            }
        }

        // Bubble stays visible until closed or replaced
        function showResponse(text, { speak = true } = {}) {
            chatText.textContent = text;
            chatBubble.style.display = 'block';
            if (speak) speakText(text);
        }

        chatClose.addEventListener('click', () => {
            chatBubble.style.display = 'none';
        });

        function processQuestion(question) {
            userQuestion.textContent = `You asked: "${question}"`;
            userQuestion.style.display = 'block';
            setTimeout(() => { userQuestion.style.display = 'none'; }, 3000);

            const lowerQuestion = question.toLowerCase();
            if (lowerQuestion.includes('module') || lowerQuestion.includes('curriculum') || lowerQuestion.includes('learn')) {
                const modules = aiAcademyInfo.modules.map(m => m.name).join(', ');
                showResponse(`The AI Academy has 10 amazing modules: ${modules}. Each module builds your skills in different areas of AI!`);
            }
            else if (lowerQuestion.includes('creative') || lowerQuestion.includes('art') || lowerQuestion.includes('music')) {
                showResponse("In our Creative AI module, you'll use generative AI to create art, music, stories, poems, and even podcasts! It's where technology meets imagination!");
            }
            else if (lowerQuestion.includes('robot')) {
                showResponse("Our AI Robotics module lets you work with micro:bits and LEGO SPIKE Prime kits to build smart robots that can sense and interact with their environment!");
            }
            else if (lowerQuestion.includes('code') || lowerQuestion.includes('programming')) {
                showResponse("We teach you how to use AI as your coding assistant! AI can help explain code, debug problems, and even generate code snippets. Plus, advanced students can learn Python and APIs!");
            }
            else if (lowerQuestion.includes('game') || lowerQuestion.includes('gaming')) {
                showResponse("In the AI in Gaming module, you'll discover how AI powers NPCs, creates game levels, and builds entire virtual worlds. It's game development meets artificial intelligence!");
            }
            else if (lowerQuestion.includes('ethic') || lowerQuestion.includes('responsible')) {
                showResponse("Ethics is at the heart of our program! We teach responsible AI use from day one, covering how AI works, how it's trained, and how to use it ethically in all applications.");
            }
            else if (lowerQuestion.includes('project') || lowerQuestion.includes('capstone')) {
                showResponse("The capstone project is where you shine! You'll identify a real-world problem and design an AI-powered solution using design-thinking. It's your chance to make a real difference!");
            }
            else if (lowerQuestion.includes('age') || lowerQuestion.includes('skill level')) {
                showResponse("The AI Academy adapts to different ages and skill levels! Projects and challenges are customized to match each student's abilities, from beginners to advanced coders.");
            }
            else if (lowerQuestion.includes('what is') || lowerQuestion.includes('tell me about')) {
                showResponse(aiAcademyInfo.overview);
            }
            else if (lowerQuestion.includes('mission') || lowerQuestion.includes('goal')) {
                showResponse(`Our mission is ${aiAcademyInfo.mission} We balance hands-on exploration with critical thinking for a complete AI education.`);
            }
            else if (lowerQuestion.includes('skill')) {
                const skills = aiAcademyInfo.skills.join(', ');
                showResponse(`You'll develop essential skills including: ${skills}. These skills prepare you for the future of technology!`);
            }
            else if (lowerQuestion.includes('hello') || lowerQuestion.includes('hi')) {
                showResponse("Hi there, Ninja! I'm here to tell you all about our awesome AI Academy! What would you like to know?");
            }
            else if (lowerQuestion.includes('thank')) {
                showResponse("You're welcome, Ninja! Keep exploring and learning - the world of AI is waiting for you!");
            }
            else {
                showResponse("Great question! The AI Academy covers everything from AI fundamentals to advanced applications. You can ask me about specific modules, projects, robotics, gaming, or how we teach ethical AI use!");
            }
        }

        // ----------------- Speech Recognition (fixed & hardened) -----------------
        let recognition;
        window.__isListening = false;

        function initSpeech() {
            if (recognition) return;

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                alert('Voice input is not supported in this browser. Try Chrome or Edge on desktop.');
                return;
            }

            recognition = new SpeechRecognition();
            recognition.continuous = false;        // one utterance per click
            recognition.interimResults = true;     // show partial text
            recognition.lang = 'en-US';

            recognition.addEventListener('start', () => {
                window.__isListening = true;
                document.getElementById('listening-indicator').style.display = 'block';
                document.getElementById('speak-btn').classList.add('active');
                // Prevent echo: cancel any speaking while we listen
                if ('speechSynthesis' in window) { try { speechSynthesis.cancel(); } catch {} }
            });

            recognition.addEventListener('end', () => {
                window.__isListening = false;
                document.getElementById('listening-indicator').style.display = 'none';
                document.getElementById('speak-btn').classList.remove('active');
                userQuestion.style.display = 'none';

                // Speak anything queued during listening
                if (__pendingSpeech) {
                    const toSpeak = __pendingSpeech;
                    __pendingSpeech = null;
                    speakText(toSpeak);
                }
            });

            recognition.addEventListener('result', (event) => {
                let transcript = '';
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    transcript += event.results[i][0].transcript;
                }

                if (!event.results[event.results.length - 1].isFinal) {
                    userQuestion.textContent = `Listening‚Ä¶ ${transcript}`;
                    userQuestion.style.display = 'block';
                    return;
                }

                transcript = transcript.trim();
                if (transcript) {
                    processQuestion(transcript); // showResponse inside will defer speech if still listening
                }

                try { recognition.stop(); } catch {}
            });

            recognition.addEventListener('error', (event) => {
                console.warn('Speech recognition error:', event.error);
                window.__isListening = false;
                document.getElementById('listening-indicator').style.display = 'none';
                document.getElementById('speak-btn').classList.remove('active');

                const msg = {
                    'no-speech': "I didn't catch that‚Äîtry speaking closer to the mic.",
                    'audio-capture': "I can't access your microphone. Check mic permissions.",
                    'not-allowed': "Please allow microphone access in your browser settings.",
                    'network': "Network error during speech recognition.",
                    'aborted': "Listening stopped."
                }[event.error] || "Voice input had a hiccup. Try again.";

                showResponse(msg);
            });
        }

        function isSecureForMic() {
            if (window.isSecureContext) return true;
            const host = location.hostname || '';
            return /^localhost$|^127\.0\.0\.1$/.test(host);
        }

        // Buttons
        document.getElementById('speak-btn').addEventListener('click', () => {
            initSpeech();
            if (!recognition) return;

            if (!isSecureForMic()) {
                alert('For voice to work, open this page over HTTPS or run it on localhost.');
                return;
            }

            try {
                if (!window.__isListening) {
                    recognition.start();
                } else {
                    recognition.stop();
                }
            } catch (err) {
                try { recognition.stop(); } catch {}
                setTimeout(() => { try { recognition.start(); } catch {} }, 200);
            }
        });

        document.getElementById('info-btn').addEventListener('click', () => {
            showResponse("Welcome to Code Ninjas AI Academy! I can tell you about our 10 modules, from AI fundamentals to robotics and game development. Just ask me anything!");
        });

        // VR Button
        document.getElementById('vr-button').addEventListener('click', async () => {
            if (navigator.xr) {
                try {
                    const sessionInit = { optionalFeatures: ['local-floor', 'bounded-floor'] };
                    const session = await navigator.xr.requestSession('immersive-vr', sessionInit);
                    renderer.xr.enabled = true;
                    renderer.xr.setSession(session);
                    renderer.setAnimationLoop(animate);
                    document.getElementById('vr-button').textContent = 'Exit VR';

                    session.addEventListener('end', () => {
                        renderer.xr.enabled = false;
                        renderer.setAnimationLoop(null);
                        document.getElementById('vr-button').textContent = 'Enter VR';
                    });
                } catch (e) {
                    alert('VR session could not be started. Make sure you have a VR headset connected.');
                }
            } else {
                alert('WebXR not supported in this browser. Try using a VR-capable browser.');
            }
        });

        // Resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // Initial greeting (the ONLY auto-hide bubble)
        setTimeout(() => {
            showResponse("Hi! I'm your Code Ninjas AI guide! Click the microphone to talk to me or ask about our AI Academy!");
            setTimeout(() => { document.getElementById('chat-bubble').style.display = 'none'; }, 10000);
        }, 1500);
    </script>
</body>
</html>
